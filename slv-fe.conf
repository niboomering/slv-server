# ------------------------------------------------------------
# 1) REDIRECT ALL HTTP → HTTPS (non-www)
# ------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name sunshineluxuryvillas.co.uk;
    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ------------------------------------------------------------
# 2) HTTPS non-www → HTTPS www
# ------------------------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/privkey.pem;

    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ------------------------------------------------------------
# 3) HTTP www → HTTPS www
# ------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name www.sunshineluxuryvillas.co.uk;
    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ------------------------------------------------------------
# 4) BOT DETECTION USING MAP (SAFE)
# ------------------------------------------------------------
map $http_user_agent $is_bot {
    default 0;
    "~*googlebot"          1;
    "~*bingbot"            1;
    "~*yandex"             1;
    "~*duckduckbot"        1;
    "~*baiduspider"        1;
    "~*facebookexternalhit" 1;
    "~*twitterbot"         1;
    "~*linkedinbot"        1;
}

# ------------------------------------------------------------
# 5) MAIN HTTPS SERVER (SEO + SPA)
# ------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/privkey.pem;

    root /var/www/slv-fe/slv-fe-dist;
    index index.html;

    # -------------------------
    # STATIC FILES FAST PATH
    # -------------------------
    location /assets/ { try_files $uri =404; }
    location /css/    { try_files $uri =404; }
    location /js/     { try_files $uri =404; }
    location /images/ { try_files $uri =404; }

    # -------------------------
    # MAIN ROUTER
    # -------------------------
    location / {
        # If bot → check SEO folder
        try_files 
            $uri 
            $uri/ 
            /seo$uri/index.html
            @spa;
    }

    # -------------------------
    # SPA FALLBACK
    # -------------------------
    location @spa {
        try_files /index.html =404;
    }
}
