# ------------------------------------------------------------
# 1) Redirect HTTP → HTTPS (non-www)
# ------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name sunshineluxuryvillas.co.uk;
    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ------------------------------------------------------------
# 2) Redirect HTTPS (non-www) → HTTPS (www)
# ------------------------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/privkey.pem;

    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ------------------------------------------------------------
# 3) Redirect HTTP www → HTTPS www
# ------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name www.sunshineluxuryvillas.co.uk;
    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ------------------------------------------------------------
# 4) MAIN HTTPS SERVER → BOT ROUTING + SPA
# ------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.sunshineluxuryvillas.co.uk-0001/privkey.pem;

    # -----------------------
    # ROOT SPA DIRECTORY
    # -----------------------
    root /var/www/slv-fe/slv-fe-dist;
    index index.html;

    # -----------------------
    # 1. Serve static files
    # -----------------------
    location /assets/ { try_files $uri =404; }
    location /images/ { try_files $uri =404; }
    location /css/    { try_files $uri =404; }
    location /js/     { try_files $uri =404; }

    # -----------------------
    # 2. Route bots → SEO HTML
    # -----------------------
    location / {
        # Detect crawlers
        set $is_bot 0;
        if ($http_user_agent ~* "googlebot|bingbot|yandex|duckduckbot|baiduspider|facebookexternalhit|twitterbot|linkedinbot") {
            set $is_bot 1;
        }

        # If bot, try serving prerendered:
        if ($is_bot = 1) {
            try_files /seo$uri/index.html @spa;
        }

        # Humans → SPA
        try_files $uri $uri/ @spa;
    }

    # -----------------------
    # 3. SPA fallback
    # -----------------------
    location @spa {
        try_files /index.html =404;
    }
}
