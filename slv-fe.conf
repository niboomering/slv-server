# ============================================================
# 0) Bot detection (map) – must be outside any server block
# ============================================================
map $http_user_agent $is_bot {
    default 0;
    ~*(bot|crawl|crawler|crawlably|crawlablybot|spider|slurp|seo|audit|lighthouse|chrome-lighthouse|pagespeed|headless|seobility|ahrefs|semrush|moz|googlebot|bingbot|yandex|duckduckbot|baiduspider|facebookexternalhit|facebot|twitterbot|linkedinbot|whatsapp|telegrambot) 1;
}

# ============================================================
# 1) Redirect HTTP → HTTPS www
# ============================================================
server {
    listen 80;
    listen [::]:80;
    server_name sunshineluxuryvillas.co.uk www.sunshineluxuryvillas.co.uk;
    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ============================================================
# 2) Redirect HTTPS non-www → HTTPS www
# ============================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/sunlux/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sunlux/privkey.pem;

    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ============================================================
# 3) Main HTTPS www server – SPA + SEO prerender + debugging
# ============================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/sunlux/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sunlux/privkey.pem;

    root /var/www/slv-fe/slv-fe-dist;
    index index.html;

    # Bot detection header
    add_header X-Is-Bot $is_bot always;

    # -------------------------
    # Static assets
    # -------------------------
    location ~* ^/(assets|css|js|images|icons)/ {
        try_files $uri =404;
    }

    # -------------------------
    # Serve prerendered pages for bots
    # -------------------------
    location / {
        # If bot, try prerendered page first
        try_files $uri $uri/ /index.html;

        # Internal redirect for bots
        error_page 418 = @bot_prerender;
    }

    # -------------------------
    # Internal location for prerendered pages
    # -------------------------
    location @bot_prerender {
        internal;

        # Only serve bots
        if ($is_bot) {
            alias /var/www/slv-fe/slv-cms/generated-pages$uri/;
            index index.html;
            default_type text/html;

            # Debug missing pages
            error_page 404 = @bot_debug;
        }

        # Humans fallback
        try_files /index.html =404;
    }

    # -------------------------
    # Bot debug location
    # -------------------------
    location @bot_debug {
        internal;
        return 404 "Bot requested missing prerendered page: $uri\n";
    }

    # -------------------------
    # SPA fallback for humans
    # -------------------------
    location / {
        try_files $uri $uri/ /index.html;
    }
}
