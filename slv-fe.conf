# ---------------------------------------------------
# Redirect HTTP → HTTPS (all non-SSL traffic)
# ---------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name sunshineluxuryvillas.co.uk www.sunshineluxuryvillas.co.uk;
    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ---------------------------------------------------
# Redirect HTTPS non-www → HTTPS www
# ---------------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/sunlux/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sunlux/privkey.pem;

    return 301 https://www.sunshineluxuryvillas.co.uk$request_uri;
}

# ---------------------------------------------------
# Main HTTPS www server (SPA + SEO for bots)
# ---------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.sunshineluxuryvillas.co.uk;

    ssl_certificate /etc/letsencrypt/live/sunlux/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sunlux/privkey.pem;

    root /var/www/slv-fe/slv-fe-dist;
    index index.html;

    add_header X-Is-Bot $is_bot always;

    # -------------------------
    # Static assets
    # -------------------------
    location ~* ^/(assets|css|js|images|icons)/ {
        try_files $uri =404;
    }

    # -------------------------
    # SPA + SEO routing
    # -------------------------
    location / {
        try_files $uri $uri/ /index.html;

        if ($is_bot) {
            rewrite ^/(.*)/?$ /seo/$1/ break;
        }
    }

    # -------------------------
    # Internal SEO prerendered pages
    # -------------------------
    location ~ ^/seo/(.*)/?$ {
        internal;
        alias /var/www/slv-fe/slv-cms/generated-pages/$1/index.html;
        default_type text/html;
    }

    # -------------------------
    # SPA fallback
    # -------------------------
    location @spa {
        try_files /index.html =404;
    }
}
